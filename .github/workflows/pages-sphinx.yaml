name: Build and Deploy Docs

on:
  push:
    branches:
      - main  # Change this if your default branch is different
      - "*"    # Run on all branches for testing purposes
  workflow_dispatch:

permissions:
  contents: write

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout Repository
        uses: actions/checkout@v4

      - name: Set Up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.x'

      - name: Install Dependencies
        run: |
          pip install sphinx myst-parser sphinx-rtd-theme pyyaml

      - name: Copy README.md Files to Docs
        run: |
          mkdir -p docs/source
          find . -name "README.md" -exec cp --parents {} docs/source/ \;
          mv docs/source/README.md docs/source/index.md

      - name: Create Static TOC for Sidebar (filenames only)
        run: |
          echo '```{toctree}' > docs/source/_auto_toctree.md
          echo ':maxdepth: 1' >> docs/source/_auto_toctree.md
          echo ':titlesonly:' >> docs/source/_auto_toctree.md
          echo '' >> docs/source/_auto_toctree.md

          find docs/source -name "README.md" | grep -v index.md | while read path; do
            relpath=$(realpath --relative-to=docs/source "$path")
            docpath="${relpath%.md}"
            echo "$docpath" >> docs/source/_auto_toctree.md
          done

          echo '```' >> docs/source/_auto_toctree.md
          cat docs/source/_auto_toctree.md >> docs/source/index.md

      - name: Create Sphinx Config
        run: |
          cat << EOF > docs/source/conf.py
import os
project = 'Wall-E Docs'
html_theme = 'sphinx_rtd_theme'
extensions = ['myst_parser']
source_suffix = ['.md']
html_static_path = ['_static']
templates_path = ['_templates']
myst_enable_extensions = ['front_matter']
html_theme_options = {
    'collapse_navigation': False,
    'titles_only': True
}
EOF

      - name: Build Sphinx Documentation
        run: |
          sphinx-build -M html docs/source docs/build
          touch docs/build/html/.nojekyll

      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v4
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: docs/build/html
          keep_files: true
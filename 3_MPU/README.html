

<!DOCTYPE html>
<html class="writer-html5" lang="en" data-content_root="../">
<head>
  <meta charset="utf-8" /><meta name="viewport" content="width=device-width, initial-scale=1" />

  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>TABLE OF CONTENTS &mdash; Wall-E Docs  documentation</title>
      <link rel="stylesheet" type="text/css" href="../_static/pygments.css?v=b86133f3" />
      <link rel="stylesheet" type="text/css" href="../_static/css/theme.css?v=e59714d7" />

  
      <script src="../_static/jquery.js?v=5d32c60e"></script>
      <script src="../_static/_sphinx_javascript_frameworks_compat.js?v=2cd50e6c"></script>
      <script src="../_static/documentation_options.js?v=5929fcd5"></script>
      <script src="../_static/doctools.js?v=9bcbadda"></script>
      <script src="../_static/sphinx_highlight.js?v=dc90522c"></script>
    <script src="../_static/js/theme.js"></script>
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" /> 
</head>

<body class="wy-body-for-nav"> 
  <div class="wy-grid-for-nav">
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >

          
          
          <a href="../index.html" class="icon icon-home">
            Wall-E Docs
          </a>
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" aria-label="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>
        </div><div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="Navigation menu">
              <!-- Local TOC -->
              <div class="local-toc"><ul>
<li><a class="reference internal" href="#">TABLE OF CONTENTS</a></li>
<li><a class="reference internal" href="#mpu6050">MPU6050</a></li>
<li><a class="reference internal" href="#inertial-measurement-unit">Inertial Measurement Unit</a></li>
<li><a class="reference internal" href="#initialising-mpu6050">Initialising MPU6050</a><ul>
<li><a class="reference internal" href="#accelerometer">Accelerometer</a></li>
<li><a class="reference internal" href="#reading-accelerometer-data">Reading Accelerometer Data</a></li>
<li><a class="reference internal" href="#accelerometer-euler-angles">Accelerometer Euler Angles</a></li>
<li><a class="reference internal" href="#gyroscope">Gyroscope</a></li>
<li><a class="reference internal" href="#reading-gyroscope-data">Reading Gyroscope Data</a></li>
<li><a class="reference internal" href="#complementary-filter">Complementary Filter</a></li>
<li><a class="reference internal" href="#reading-register-data">Reading Register Data</a></li>
<li><a class="reference internal" href="#description-of-functions-used">Description of Functions Used</a></li>
<li><a class="reference internal" href="#flowchart-of-code">Flowchart of Code</a></li>
</ul>
</li>
</ul>
</div>
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap"><nav class="wy-nav-top" aria-label="Mobile navigation menu" >
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">Wall-E Docs</a>
      </nav>

      <div class="wy-nav-content">
        <div class="rst-content">
          <div role="navigation" aria-label="Page navigation">
  <ul class="wy-breadcrumbs">
      <li><a href="../index.html" class="icon icon-home" aria-label="Home"></a></li>
      <li class="breadcrumb-item active">TABLE OF CONTENTS</li>
      <li class="wy-breadcrumbs-aside">
            <a href="../_sources/3_MPU/README.md.txt" rel="nofollow"> View page source</a>
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
             
  <section id="table-of-contents">
<h1>TABLE OF CONTENTS<a class="headerlink" href="#table-of-contents" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p><a class="reference internal" href="#table-of-contents"><span class="xref myst">TABLE OF CONTENTS</span></a></p></li>
<li><p><a class="reference internal" href="#mpu6050"><span class="xref myst">MPU6050</span></a></p></li>
<li><p><a class="reference internal" href="#inertial-measurement-unit"><span class="xref myst">Inertial Measurement Unit</span></a></p></li>
<li><p><a class="reference internal" href="#initialising-mpu6050"><span class="xref myst">Initialising MPU6050</span></a></p>
<ul>
<li><p><a class="reference internal" href="#accelerometer"><span class="xref myst">Accelerometer</span></a></p></li>
<li><p><a class="reference internal" href="#reading-accelerometer-data"><span class="xref myst">Reading Accelerometer Data</span></a></p></li>
<li><p><a class="reference internal" href="#accelerometer-euler-angles"><span class="xref myst">Accelerometer Euler Angles</span></a></p></li>
<li><p><a class="reference internal" href="#gyroscope"><span class="xref myst">Gyroscope</span></a></p></li>
<li><p><a class="reference internal" href="#reading-gyroscope-data"><span class="xref myst">Reading Gyroscope Data</span></a></p></li>
<li><p><a class="reference internal" href="#complementary-filter"><span class="xref myst">Complementary Filter</span></a></p></li>
<li><p><a class="reference internal" href="#reading-register-data"><span class="xref myst">Reading Register Data</span></a></p></li>
</ul>
</li>
<li><p><a class="reference internal" href="#description-of-functions-used"><span class="xref myst">Description of Functions Used</span></a></p></li>
<li><p><a class="reference internal" href="#flowchart-of-code"><span class="xref myst">Flowchart of Code</span></a></p></li>
</ul>
</section>
<section id="mpu6050">
<h1>MPU6050<a class="headerlink" href="#mpu6050" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>It is a 6-axis motion tracking device</p></li>
<li><p>The MPU-6050 is a commonly used chip that combines a MEMS gyroscope and a MEMS accelerometer and uses a standard I2C bus for data transmission</p></li>
<li><p>The system processor is an I2C master to the MPU6050 (default address is 0x68 but can be changed to 0x69)</p></li>
<li><p>The MPU6050 can also act as an I2C master and directly accept inputs from an external compass</p></li>
<li><p>This is 3.3V device and hence is safe to connect to ESP32 pins directly.</p></li>
</ul>
<p><img alt="" src="https://lh5.googleusercontent.com/zS7Xrh9qRU7qUwhcF6BoJwzG7Pex7cvjD3yFqS_rJA35Nuj-rDkpS9uEt6EjqmGwzEEe3k-jNw2ENILxgxKWGLO5hW6j1er4oaKXk-ciVyrCC4GvzMDzwR9l0u5CrtsNRpAI7LRqf7U" /></p>
</section>
<section id="inertial-measurement-unit">
<h1>Inertial Measurement Unit<a class="headerlink" href="#inertial-measurement-unit" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>These are small devices indicating changing orientation in smartphones, video game remotes, quadcopters, etc.</p></li>
<li><p>The IMU has both a gyroscope which measures angular rate and an accelerometer which measures linear acceleration, and/or compasses (magnetometers)</p></li>
<li><p>The number of sensor inputs in an IMU are referred to as ‘DoF’ (Degrees of Freedom), so a chip with a 3-axis gyroscope and a 3-axis accelerometer would be a 6-DOF IMU.</p></li>
</ul>
</section>
<section id="initialising-mpu6050">
<h1>Initialising MPU6050<a class="headerlink" href="#initialising-mpu6050" title="Link to this heading"></a></h1>
<ul class="simple">
<li><p>A sample wiring of the device to ESP32 looks as follows:
<img alt="" src="https://lh5.googleusercontent.com/OiTQl8mZl41Dwa_Nb6PD6yzMigvv6xV7KnY7bfW56dBSoYuK8shYet7VMev0rVWcFWhirvUIenbFn_B6jc_nmTulH4-3vInHrOZX3sW4f2lBvel_HcthTW_O89FAGwankOtBBJ8aLhY" /></p></li>
<li><p>When power up, MPU6050 will start in SLEEP mode. To use it, we need to first disable this SLEEP mode</p></li>
<li><p>To use the I2C protocol, we send the value 0 to register PWR_MGMT_1 (0x6b)</p></li>
<li><p>The procedure to do so is as follows :</p>
<ol class="arabic simple">
<li><p>Send a start sequence</p></li>
<li><p>Send the I2C address (0x68) of the MPU6050 with the R/W bit high</p></li>
<li><p>Send the internal register number you want to write to (0x6b : PWR_MGMT_1)</p></li>
<li><p>Send the data byte (0x00) - This will power on the device</p></li>
<li><p>Send the stop sequence</p></li>
</ol>
</li>
</ul>
<p><img alt="" src="https://lh5.googleusercontent.com/HsUgcO1ojRlHZgbtl1Pyk7aWiUjs1x7XnhI5oYsa8C2gCqAbfqOGpr9fnjk0TBxWHmoIfJEQLqHUqe4Kh3KsjMLKSHAD6jQMsiEwrNyA3KLSeHiNLC3tDjzjAKN_nENu8FMp0tYS60E" /></p>
<p>The data byte 0x00 sets all the bits of register 107 to 0, thus disabling SLEEP mode and CYCLE mode, and powering on the MPU-6050</p>
<p><img alt="" src="https://lh3.googleusercontent.com/4p2RF-ezjP6jtT6S7xBQGfls0bcj7JM27W_ZsgRj5pYGQKBnrHfP85MtPncMeuu5qmSEupHdCSu2qPf4TSSBbejcN5MMqU5gLvLMaUDsw9K-Zp7vwLNIiD42d8xdfBKu0A0qxFaS6jk" /></p>
<p>There are various terms related with the Pulse Width Modulation:-</p>
<ul class="simple">
<li><p><strong>Off-Time</strong> :- Duration of time period when the signal is low.</p></li>
<li><p><strong>ON-Time</strong>  :- Duration of time period when the signal is high.</p></li>
<li><p><strong>Duty cycle</strong> :- It is the percentage of the time period when the signal remains ON during the period of the pulse width modulation signal.</p></li>
<li><p><strong>Period</strong> :- It is the sum of off-time and on-time of pulse width modulation signal.</p></li>
</ul>
<section id="accelerometer">
<h2>Accelerometer<a class="headerlink" href="#accelerometer" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>An accelerometer is a sensor that measures the <strong>force</strong> of linear acceleration.</p></li>
<li><p>It’s output is in the form of m/s^2 of g-forces on a body. It is highly sensitive to movement in any direction.</p></li>
<li><p>The MPU6050 uses a MEMS accelerometer, which consists of stationary and movable electrodes acting as <strong>capacitor plates</strong></p></li>
<li><p>Acceleration produces change in g-forces on the moving device, which causes displacement of the movable capacitor plates</p></li>
<li><p>This causes a change in capacitance across the plates, which is detected internally by change in Voltage</p></li>
<li><p>We then calculate the displacement from the in Capacitance, which helps us infer the value of acceleration</p></li>
</ul>
<p><img alt="" src="https://lastminuteengineers.com/wp-content/uploads/arduino/MEMS-Accelerometer-Working.gif" /></p>
<p><img alt="" src="https://lastminuteengineers.com/wp-content/uploads/arduino/Accelerometer-Animation-Labels.png" /></p>
</section>
<section id="reading-accelerometer-data">
<h2>Reading Accelerometer Data<a class="headerlink" href="#reading-accelerometer-data" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>The acceleration of the three axes, X,Y and Z, are stored in 3 pairs of registers on the MPU6050</p></li>
<li><p>Each register on the MPU6050 is an 8-bit register</p></li>
<li><p>In each of these pairs, one register stores the MSB (most significant bit) and the other stores the LSB (least significant bit)</p></li>
<li><p>These 6 registers are <a class="reference internal" href="#reading-register-data"><span class="xref myst">burst-read</span></a> and the 8-bit MSB and LSB bytes for each axis are combined to give a single 16-bit float</p></li>
</ul>
<p><img alt="" src="https://lh4.googleusercontent.com/ePwQEj_TeMRQU83M7t2RsXGJD2q37z-B3kSlcLdU85L4XeKxkefT_fAYHNRpRjGOYI8r0bbQWd64I7emYms9x4ST6jEAdBlcC2wdibE" /></p>
</section>
<section id="accelerometer-euler-angles">
<h2>Accelerometer Euler Angles<a class="headerlink" href="#accelerometer-euler-angles" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>The roll and pitch angles are calculated from the accelerometer using the <a class="reference external" href="https://www.digikey.com/en/articles/using-an-accelerometer-for-inclination-sensing">formula</a> below :</p></li>
</ul>
<p>$$\theta = \arctan\left(\frac{A_{X.OUT}}{A_{Y.OUT}}\right)$$</p>
</section>
<section id="gyroscope">
<h2>Gyroscope<a class="headerlink" href="#gyroscope" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>A gyroscope is a sensor that measures the change in velocity (if at all) of a device rotating around its own axis.</p></li>
<li><p>A gyroscope measures <strong>changes</strong> in angular velocity.</p></li>
<li><p>The MPU6050 uses a MEMS gyroscope, which uses <a class="reference external" href="https://www.youtube.com/watch?v=ti4HEgd4Fgo&amp;amp;t=236s">Coriolis effect</a></p></li>
</ul>
</section>
<section id="reading-gyroscope-data">
<h2>Reading Gyroscope Data<a class="headerlink" href="#reading-gyroscope-data" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>The acceleration of the three axes, X,Y and Z, are stored in 3 pairs of registers on the MPU6050</p></li>
<li><p>Each register on the MPU6050 is an 8-bit register</p></li>
<li><p>In each of these pairs, one register stores the MSB (most significant bit) and the other stores the LSB (least significant bit)</p></li>
<li><p>These 6 registers are <a class="reference internal" href="#reading-register-data"><span class="xref myst">burst-read</span></a> and the 8-bit MSB and LSB bytes for each axis are combined to give a single 16-bit float</p></li>
<li><p>The gyroscope has a sensitivity factor of about 131, i.e. 1 degree of rotation gives a reading of 131 units</p></li>
<li><p>Therefore, the degrees of rotation are obtained by dividing the raw readings by 131</p></li>
<li><p>Euler angles are calculated by integrating raw readings of each axis over time</p></li>
</ul>
<p><img alt="" src="https://lh3.googleusercontent.com/dQ-SZL7kp5WEnFb-KXFH-FDvF7yv_2J28ycODkipFfFAAMN1lYAk0rPzKg7DaPcNDYk-BdUEJQSzApxxESam_7tnbsIOcLenjofFoUiCpAhsyuMtkWaFMcZPJrK5EMJyX9GCNHSNeeo" /></p>
</section>
<section id="complementary-filter">
<h2>Complementary Filter<a class="headerlink" href="#complementary-filter" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>Since gyroscopic drift accumulates over time, it is necessary to reset the rate readings from the gyroscope at frequent intervals, so the drift can be minimised</p></li>
<li><p>To do this, we combine both the gyroscope and accelerometer readings in a weighted average</p></li>
<li><p>The value of alpha is determined experimentally</p></li>
</ul>
<p><img alt="" src="http://www.pieter-jan.com/images/equations/CompFilter_Eq.gif" /></p>
</section>
<section id="reading-register-data">
<h2>Reading Register Data<a class="headerlink" href="#reading-register-data" title="Link to this heading"></a></h2>
<ul class="simple">
<li><p>To read/receive data from a slave, the master has to first send a START condition addressing the MPU6050</p></li>
<li><p>Then the master must WRITE the requested register from which the data is to be read</p></li>
<li><p>After this, instead of sending a STOP condition to stop the WRITE operation and then sending a consecutive START condition to start the READ operation,
the I2C bus provides the <strong>repeated start</strong> functionality, wherein instead of sending a STOP-START condition, we send only a START condition and read the
specified number of bytes from the register.</p></li>
<li><p>The procedure to do so is as follows :</p>
<ol class="arabic simple">
<li><p>Send a start sequence</p></li>
<li><p>Send the I2C address (0x68) of the MPU6050 with the R/W bit low - This writes to the device</p></li>
<li><p>Send the Internal register address you want to read from</p></li>
<li><p>Send a start sequence again (repeated start)</p></li>
<li><p>Send the I2C address of the device with the R/W bit high - This reads from the device</p></li>
<li><p>Read the number of the requested data bytes from the registers</p></li>
<li><p>Send the stop sequence.</p></li>
<li><p>All write and read operations (except the last read) are answered with a ACK if successful.</p></li>
</ol>
</li>
</ul>
<p><img alt="" src="http://www.i2c-bus.org/static/i2c/repeatedstart.gif" /></p>
<p><img alt="" src="https://i.stack.imgur.com/FHPKk.png" /></p>
</section>
<section id="description-of-functions-used">
<h2>Description of Functions Used<a class="headerlink" href="#description-of-functions-used" title="Link to this heading"></a></h2>
<ul>
<li><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">esp_err_t</span><span class="w"> </span><span class="n">enable_mpu6050</span><span class="p">()</span><span class="w">	</span>
</pre></div>
</div>
<p><strong>Description</strong> : MPU6050 comes up in sleep mode upon power-up . It disables the SLEEP_MODE of the MPU by accessing the POWER_MANAGEMENT_1 register
and checks if the MPU is initialised correctly.</p>
<p><strong>Parameters</strong> :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">None</span></code></p></li>
</ul>
<p><strong>Returns</strong> : esp_err_t returns ESP_OK if MPU is enabled properly.</p>
</li>
<li><div class="highlight-c notranslate"><div class="highlight"><pre><span></span><span class="w">  </span><span class="n">esp_err_t</span><span class="w"> </span><span class="n">read_mpu6050</span><span class="p">(</span><span class="n">euler_angle</span><span class="p">,</span><span class="w"> </span><span class="n">mpu_offset</span><span class="p">)</span>
</pre></div>
</div>
<p><strong>Description</strong> : Calculates the Roll and Pitch angles of the bot by applying complementary filter to the raw accelerometer and gyroscope values and using the given MPU offset. It stores the Roll angle in euler_angle[0] and the Pitch engle in euler_angle[1].</p>
<p><strong>Parameters</strong> :</p>
<ul class="simple">
<li><p><code class="docutils literal notranslate"><span class="pre">euler_angle</span></code> : Array to store euler angles , Pitch and Roll.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">mpu_offset</span></code> : Array to specify MPU offsets , Pitch offset ( About Y-axis ) and Roll offset (About X-axis).</p></li>
</ul>
<p><strong>Returns</strong> : esp_err_t returns ESP_OK if it read mpu successfully, else it returns ESP_FAIL.</p>
</li>
</ul>
</section>
<section id="flowchart-of-code">
<h2>Flowchart of Code<a class="headerlink" href="#flowchart-of-code" title="Link to this heading"></a></h2>
<p><img alt="Flowchart MPU(8)" src="https://user-images.githubusercontent.com/111511248/200386895-31b7aea2-8a0f-436d-b0dc-cdfb17058a70.png" /></p>
</section>
</section>


           </div>
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>&#169; Copyright .</p>
  </div>

  Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    provided by <a href="https://readthedocs.org">Read the Docs</a>.
   

</footer>
        </div>
      </div>
    </section>
  </div>
  <script>
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script> 

</body>
</html>